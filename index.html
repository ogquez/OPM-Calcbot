<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="eBay Fee Calculator">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f5f5f5" media="(prefers-color-scheme: light)">
    <title>eBay Fee Calculator - Modern</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: pan-x pan-y;
        }
        button, input, select, label { touch-action: manipulation; }

        :root {
            /* Modern color system */
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #6b7280;
            
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #1a1a1a;
            
            --accent-purple: #667eea;
            --accent-purple-light: #8b9cff;
            
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            
            /* Spacing scale (8px base) */
            --space-1: 0.5rem;   /* 8px */
            --space-2: 1rem;     /* 16px */
            --space-3: 1.5rem;   /* 24px */
            --space-4: 2rem;     /* 32px */
            --space-5: 2.5rem;   /* 40px */
            --space-6: 3rem;     /* 48px */
            
            /* Border radius scale */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-2xl: 24px;
            --radius-full: 9999px;
            
            /* Typography */
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
    
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        /* iOS System Colors (UIColor Equivalents)                             */
        /* These map directly to Color.green, Color.red, etc. in SwiftUI      */
        /* Light mode values from Apple Human Interface Guidelines            */
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        
        --ios-green-r: 52;
        --ios-green-g: 199;
        --ios-green-b: 89;
        
        --ios-yellow-r: 255;
        --ios-yellow-g: 204;
        --ios-yellow-b: 0;
        
        --ios-orange-r: 255;
        --ios-orange-g: 149;
        --ios-orange-b: 0;
        
        --ios-red-r: 255;
        --ios-red-g: 59;
        --ios-red-b: 48;
        
        --ios-blue-r: 0;
        --ios-blue-g: 122;
        --ios-blue-b: 255;
        
        --ios-purple-r: 175;
        --ios-purple-g: 82;
        --ios-purple-b: 222;
        
        /* Convenience rgba() constructors */
        --ios-green: rgba(var(--ios-green-r), var(--ios-green-g), var(--ios-green-b), 1);
        --ios-yellow: rgba(var(--ios-yellow-r), var(--ios-yellow-g), var(--ios-yellow-b), 1);
        --ios-orange: rgba(var(--ios-orange-r), var(--ios-orange-g), var(--ios-orange-b), 1);
        --ios-red: rgba(var(--ios-red-r), var(--ios-red-g), var(--ios-red-b), 1);
        --ios-blue: rgba(var(--ios-blue-r), var(--ios-blue-g), var(--ios-blue-b), 1);
        --ios-purple: rgba(var(--ios-purple-r), var(--ios-purple-g), var(--ios-purple-b), 1);
    }

        [data-theme="light"] {
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
            
            --text-primary: #1a1a2e;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f9fafb;
        }

        html {
            height: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            height: 100vh;
            height: 100dvh;
            max-height: 100vh;
            max-height: 100dvh;
            overflow: hidden;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            color: var(--text-primary);
            overflow-x: hidden;
            transition: background 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        /* Animated gradient background */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(118, 75, 162, 0.15) 0%, transparent 50%);
            animation: gradientShift 20s ease infinite;
            z-index: -1;
            pointer-events: none;
        }

        @keyframes gradientShift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(10%, -5%) rotate(120deg); }
            66% { transform: translate(-5%, 10%) rotate(240deg); }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 12px;
        }

        /* Header with glassmorphism */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px 16px;
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--glass-shadow), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 10;
        }

        .header-left h1 {
            font-size: 1.2rem;
            font-weight: var(--font-weight-bold);
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2px;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: var(--font-weight-medium);
        }

        /* Theme toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .theme-toggle-label {
            font-size: 1.25rem;
            opacity: 0.6;
            transition: all 0.3s;
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--glass-border);
            flex-shrink: 0;
            /* iOS: expand tap target via padding without changing visual size */
            -webkit-tap-highlight-color: transparent;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-gradient);
            top: 2px;
            left: 2px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .toggle-switch.active::before {
            transform: translateX(26px);
        }

        .toggle-switch:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        @media (hover: hover) {
            .toggle-switch:hover { transform: scale(1.03); }
        }

        /* Main content grid */
        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 10px;
            align-items: start;
        }

        /* Left/Right panels */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Glassmorphism cards */
        .glass-card {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 14px 16px;
            box-shadow: var(--glass-shadow), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(102, 126, 234, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        /* Mode toggle pills */
        .mode-toggle {
            display: flex;
            gap: 6px;
            padding: 4px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-full);
            margin-bottom: 10px;
        }

        .mode-btn {
            flex: 1;
            padding: 7px 14px;
            border: none;
            border-radius: var(--radius-full);
            font-size: 0.8125rem;
            font-weight: var(--font-weight-semibold);
            color: var(--text-secondary);
            background: transparent;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .mode-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: -1;
        }

        .mode-btn.active {
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }

        .mode-btn.active::before {
            opacity: 1;
        }

        /* Quick mode vs Advanced toggle */
        .complexity-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: var(--radius-md);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .complexity-toggle label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 0.875rem;
            font-weight: var(--font-weight-semibold);
            color: var(--accent-purple-light);
            cursor: pointer;
        }

        .complexity-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-purple);
        }

        /* Smart category search */
        .category-search-wrapper {
            position: relative;
            margin-bottom: 10px;
        }

        .category-search {
            width: 100%;
            padding: 9px 36px 9px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9375rem;
            font-weight: var(--font-weight-medium);
            transition: all 0.3s;
        }

        .category-search:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }

        .category-search::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.25rem;
            color: var(--text-muted);
            pointer-events: none;
        }

        .category-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 8px;
            background: rgba(14, 14, 24, 0.97);
            -webkit-backdrop-filter: blur(40px) saturate(200%);
            backdrop-filter: blur(40px) saturate(200%);
            border: 1px solid rgba(102, 126, 234, 0.35);
            border-radius: var(--radius-lg);
            box-shadow: 0 24px 64px rgba(0,0,0,0.55);
            max-height: 320px;
            overflow-y: auto;
            z-index: 200;
            display: none;
        }
        [data-theme="light"] .category-suggestions {
            background: rgba(255,255,255,0.97);
            border-color: rgba(102,126,234,0.3);
            box-shadow: 0 24px 64px rgba(0,0,0,0.14);
        }
        .category-suggestion-name { color: #e8e8f5; }
        .category-suggestion-rate { color: rgba(160,160,200,0.85); }
        [data-theme="light"] .category-suggestion-name { color: var(--text-primary); }
        [data-theme="light"] .category-suggestion-rate { color: var(--text-secondary);
        }

        .category-suggestions.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .category-suggestion {
            padding: var(--space-2) var(--space-3);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .category-suggestion:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .category-suggestion-icon {
            font-size: 1.25rem;
        }

        .category-suggestion-text {
            flex: 1;
        }

        .category-suggestion-name {
            font-size: 0.875rem;
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
        }

        .category-suggestion-rate {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .suggestion-group-label {
            padding: var(--space-1) var(--space-3);
            font-size: 0.75rem;
            font-weight: var(--font-weight-bold);
            color: var(--accent-purple);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: rgba(102, 126, 234, 0.1);
        }

        /* Input groups */
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group {
            position: relative;
        }

        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 0.6875rem;
            font-weight: var(--font-weight-bold);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9375rem;
            font-weight: var(--font-weight-medium);
            transition: all 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }

        .input-group input::placeholder {
            color: var(--text-muted);
        }

        /* Remove spinner arrows */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .input-helper {
            margin-top: 6px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Advanced section (collapsible) */
        .advanced-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        .advanced-section.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        /* Profit health indicator */
        .profit-health {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: var(--radius-md);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .health-dots {
            display: flex;
            gap: 6px;
        }

        .health-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .health-dot.active {
            background: var(--success);
            box-shadow: 0 0 12px var(--success);
            animation: pulse 2s ease infinite;
        }

        .health-dot.active.warning {
            background: var(--warning);
            box-shadow: 0 0 12px var(--warning);
        }

        .health-dot.active.danger {
            background: var(--danger);
            box-shadow: 0 0 12px var(--danger);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .health-label {
            flex: 1;
            font-size: 0.875rem;
            font-weight: var(--font-weight-semibold);
        }

        .health-score {
            font-size: 1.1rem;
            font-weight: var(--font-weight-bold);
            background: var(--success-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Results card */
        .results-card {
            position: sticky;
            top: 0;
        }

        .result-hero {
            padding: 14px 16px;
            background: var(--primary-gradient);
            border-radius: var(--radius-lg);
            text-align: center;
            margin-bottom: 10px;
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }

        .result-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-label {
            font-size: 0.6875rem;
            font-weight: var(--font-weight-semibold);
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 2px;
        }

        .result-value {
            font-size: 2rem;
            font-weight: var(--font-weight-bold);
            color: white;
            line-height: 1;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .result-margin {
            margin-top: 4px;
            font-size: 0.875rem;
            font-weight: var(--font-weight-semibold);
            color: rgba(255, 255, 255, 0.9);
        }

        /* Result rows */
        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 7px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-row-label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            font-weight: var(--font-weight-medium);
        }

        .result-row-value {
            font-size: 0.8125rem;
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
        }

        /* Fee breakdown accordion */
        .fee-accordion {
            margin: 8px 0;
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s;
        }

        .fee-accordion:hover {
            background: rgba(102, 126, 234, 0.15);
        }

        .fee-accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fee-accordion-icon {
            transition: transform 0.3s;
        }

        .fee-accordion.active .fee-accordion-icon {
            transform: rotate(180deg);
        }

        .fee-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .fee-accordion.active .fee-accordion-content {
            max-height: 500px;
            padding-top: var(--space-3);
        }

        /* Quick actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .action-btn {
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.8125rem;
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: var(--accent-purple);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .action-btn:active {
            transform: scale(0.96);
        }



        /* Mobile enhancements */
        .mobile-profit-bar {
            display: none;
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--primary-gradient);
            padding: 14px 16px 16px;
            margin: 0 0 12px 0;
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 24px rgba(102, 126, 234, 0.35);
            width: 100%;
            box-sizing: border-box;
        }

        .mobile-profit-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .mobile-profit-label {
            font-size: 0.75rem;
            font-weight: var(--font-weight-bold);
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .mobile-profit-value {
            font-size: 1.375rem;
            font-weight: var(--font-weight-bold);
            color: white;
        }

        .mobile-profit-details {
            display: flex;
            gap: 16px;
            font-size: 0.8125rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .mobile-profit-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            /* Restore scrolling on mobile ‚Äî desktop uses overflow:hidden */
            body {
                height: auto;
                min-height: 100vh;
                min-height: -webkit-fill-available;
                max-height: none;
                overflow: auto;
                -webkit-overflow-scrolling: touch;
            }

            .content-wrapper {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .results-card {
                position: static;
            }

            .mobile-profit-bar {
                display: block;
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 10px 12px;
            }

            .header-left h1 {
                font-size: 1.1rem;
            }

            .subtitle {
                font-size: 0.6875rem;
            }

            .input-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .quick-actions {
                grid-template-columns: 1fr 1fr;
            }

            .result-value {
                font-size: 1.75rem;
            }
        }

        /* Loading shimmer */
        .shimmer {
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            background-size: 200% 100%;
            animation: shimmer-animation 2s infinite;
        }

        @keyframes shimmer-animation {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Tooltips */
        .tooltip-trigger {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            margin-left: 6px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 50%;
            font-size: 0.625rem;
            font-weight: var(--font-weight-bold);
            color: var(--accent-purple);
            cursor: help;
            transition: all 0.3s;
        }

        .tooltip-trigger:hover {
            background: rgba(102, 126, 234, 0.3);
            transform: scale(1.1);
        }

        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            padding: var(--space-2);
            background: rgba(0, 0, 0, 0.95);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            line-height: 1.4;
            color: white;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .tooltip-trigger:hover .tooltip-content {
            opacity: 1;
            transform: translateX(-50%) translateY(-12px);
        }

        /* Success animation */
        @keyframes success-bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .success-animation {
            animation: success-bounce 0.6s ease;
        }

        /* ========== iOS SPECIFIC COMPATIBILITY ========== */
        
        /* iOS Safari support */
        @supports (-webkit-touch-callout: none) {
            /* Ensure body fills viewport on iOS */
            html {
                height: 100%;
                min-height: 100%;
            }
            
            body {
                min-height: -webkit-fill-available;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Fix iOS input zoom */
            input[type="text"],
            input[type="number"],
            select {
                font-size: 16px; /* Prevents iOS zoom on focus */
            }
            
            /* Smooth scrolling for iOS */
            .category-suggestions {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Fix for iOS notch in landscape */
            @media (orientation: landscape) {
                body {
                    padding-left: max(env(safe-area-inset-left), 20px);
                    padding-right: max(env(safe-area-inset-right), 20px);
                }
                /* Two-column on landscape phones */
                .content-wrapper {
                    grid-template-columns: 1fr 300px;
                    gap: 10px;
                }
                .results-card { position: sticky; top: 0; }
                .mobile-profit-bar { display: none; }
            }
            
            /* Fix iOS button appearance */
            button {
                -webkit-appearance: none;
                appearance: none;
            }
            
            /* Fix iOS select appearance */
            select {
                -webkit-appearance: none;
                appearance: none;
            }
        }
        
        /* Fallback for browsers without backdrop-filter support (older iOS) */
        @supports not (backdrop-filter: blur(1px)) and not (-webkit-backdrop-filter: blur(1px)) {
            .header,
            .glass-card,
            .category-suggestions {
                background: var(--bg-secondary);
                border: 1px solid var(--glass-border);
            }
            
            .tooltip-content {
                background: rgba(0, 0, 0, 1);
            }
        }
        
        /* Enhanced safe area handling for all iOS devices */
        @media (max-width: 1024px) {
            /* Ensure container respects safe areas */
            .container {
                padding-left: max(var(--space-3), env(safe-area-inset-left));
                padding-right: max(var(--space-3), env(safe-area-inset-right));
                padding-bottom: max(var(--space-3), env(safe-area-inset-bottom));
            }
            
            /* Mobile profit bar with safe area */
            .mobile-profit-bar {
                padding-top: max(14px, calc(env(safe-area-inset-top) + 10px));
            }
        }
        
        /* Fix for older iOS versions (iOS 9-11) */
        @media (max-width: 640px) {
            /* Ensure minimum font size */
            * {
                -webkit-text-size-adjust: 100%;
                text-size-adjust: 100%;
            }
            
            /* iOS touch targets - minimum 44px per Apple HIG */
            input,
            select {
                min-height: 44px;
            }
            
            button,
            .action-btn,
            .mode-btn {
                min-height: 44px;
                touch-action: manipulation;
            }
            /* toggle-switch: tap target via theme-toggle padding, NOT min-height */
            .theme-toggle {
                padding: 7px 0;  /* gives 44px total tap height: 30 + 7+7 */
            }
            .toggle-switch {
                touch-action: manipulation;
            }
        }
        
        /* Prevent iOS rubber band scrolling on fixed elements */
        .mobile-profit-bar {
            position: -webkit-sticky;
            position: sticky;
        }
        
        /* Fix iOS transform performance */
        .glass-card,
        .action-btn,
        .mode-btn,
        .toggle-switch {
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }
        
        /* Optimize iOS animations */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        /* Collapsible Result Sections - iOS Design Guidelines Compliant      */
        /* Following Apple HIG: https://developer.apple.com/design/human-     */
        /* interface-guidelines/patterns/accessing-private-data               */
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        
        .result-section {
            margin-bottom: 10px;
            border-radius: var(--radius-md);
            overflow: hidden;
            background: rgba(102, 126, 234, 0.05);
            border: 1px solid rgba(102, 126, 234, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .result-section:hover {
            background: rgba(102, 126, 234, 0.08);
        }

        /* iOS HIG: Minimum 44pt touch target */
        .result-section-header {
            /* Reset button defaults */
            all: unset;
            box-sizing: border-box;
            
            /* Custom styling */
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            min-height: 44px;
            padding: 10px 12px;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.15s ease;
            
            /* Ensure text inherits color */
            color: inherit;
        }

        /* iOS active state (not :active to avoid desktop hover conflicts) */
        .result-section-header.touching {
            background: rgba(102, 126, 234, 0.12);
        }

        .result-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            font-weight: var(--font-weight-bold);
            color: var(--accent-purple-light) !important;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        
        /* Ensure nested spans also get the color */
        .result-section-title span {
            color: inherit;
        }

        .result-section-icon {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        /* iOS-style chevron with smooth rotation */
        .result-section-chevron {
            font-size: 0.875rem;
            color: var(--text-secondary);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
            will-change: transform;
        }

        .result-section.expanded .result-section-chevron {
            transform: rotate(180deg);
        }

        /* Smooth height animation using max-height */
        .result-section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: max-height;
        }

        .result-section.expanded .result-section-content {
            max-height: 600px; /* Enough for any section content */
        }

        .result-section-body {
            padding: 0 12px 12px 12px;
        }

        /* Always-visible summary (no collapse) */
        .result-summary {
            background: transparent;
            border: none;
            margin-bottom: 12px;
        }

        .result-summary .result-row {
            padding: 8px 0;
        }

        /* iOS-style divider */
        .section-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.08);
            margin: 8px 0;
        }

        /* iOS Accessibility: Reduce Motion */
        @media (prefers-reduced-motion: reduce) {
            .result-section-content,
            .result-section-chevron {
                transition-duration: 0.01ms !important;
            }
        }

        /* iOS VoiceOver support - hidden but accessible */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Light mode adjustments */
        [data-theme="light"] .result-section {
            background: rgba(102, 126, 234, 0.08);
            border-color: rgba(102, 126, 234, 0.2);
        }

        [data-theme="light"] .result-section:hover {
            background: rgba(102, 126, 234, 0.12);
        }

        [data-theme="light"] .section-divider {
            background: rgba(0, 0, 0, 0.1);
        }

        /* save panel */
        .save-panel {
            margin-top: var(--space-3);
            padding: var(--space-3);
            background: rgba(102, 126, 234, 0.08);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: var(--radius-lg);
            animation: slideDown 0.25s ease;
            overflow: hidden;
            box-sizing: border-box;
            width: 100%;
        }
        .save-panel-label {
            display: block;
            font-size: 0.75rem;
            font-weight: var(--font-weight-bold);
            color: var(--accent-purple-light);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: var(--space-2);
        }
        .save-panel-input {
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding: 11px 12px;
            margin-bottom: var(--space-2);
            background: rgba(255,255,255,0.07);
            border: 1.5px solid rgba(102,126,234,0.4);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9375rem;
            font-weight: var(--font-weight-medium);
            font-family: var(--font-sans);
        }
        .save-panel-input:focus {
            outline: none;
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
        }
        .save-panel-btns {
            display: flex;
            gap: var(--space-2);
            width: 100%;
            box-sizing: border-box;
        }
        .save-confirm-btn {
            flex: 1;
            padding: 11px 12px;
            background: var(--primary-gradient);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-size: 0.875rem;
            font-weight: var(--font-weight-bold);
            font-family: var(--font-sans);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(102,126,234,0.35);
        }
        .save-confirm-btn:hover  { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(102,126,234,0.45); }
        .save-confirm-btn:active { transform: scale(0.97); }
        .save-cancel-btn {
            padding: 11px 20px;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: var(--font-weight-semibold);
            font-family: var(--font-sans);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .save-cancel-btn:hover { background: rgba(255,255,255,0.12); color: var(--text-primary); }
    </style>

    <!-- PWA Meta Tags -->
    <meta name="application-name" content="eBay Fee Calculator">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="eBay Calc">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    
    <!-- Apple Touch Icons (GitHub-hosted) -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/ogquez/OPM-Calcbot/main/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="https://raw.githubusercontent.com/ogquez/OPM-Calcbot/main/icons/icon-192.png">
    
    <!-- Standard favicon (GitHub-hosted) -->
    <link rel="icon" type="image/png" sizes="192x192" href="https://raw.githubusercontent.com/ogquez/OPM-Calcbot/main/icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="https://raw.githubusercontent.com/ogquez/OPM-Calcbot/main/icons/icon-512.png">
    
    <!-- Web App Manifest (GitHub-hosted) -->
    <link rel="manifest" href="https://raw.githubusercontent.com/ogquez/OPM-Calcbot/main/manifest.json">
    
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>üí∞ eBay Fee Calculator</h1>
                <p class="subtitle">Modern, accurate, and beautiful</p>
            </div>
            <div class="theme-toggle">
                <span class="theme-toggle-label">üåô</span>
                <div class="toggle-switch" id="themeToggle"></div>
                <span class="theme-toggle-label">‚òÄÔ∏è</span>
            </div>
        </div>

        <div class="content-wrapper">
            <!-- Left Panel: Inputs -->
            <div class="left-panel">
                <!-- Mobile Sticky Bar -->
                <div class="mobile-profit-bar">
                    <div class="mobile-profit-main">
                        <span class="mobile-profit-label">Net Profit</span>
                        <span class="mobile-profit-value" id="mobileProfitValue">$0.00</span>
                    </div>
                    <div class="mobile-profit-details">
                        <div class="mobile-profit-stat">
                            <span>üìä</span>
                            <span id="mobileMargin">0% margin</span>
                        </div>
                        <div class="mobile-profit-stat">
                            <span>üí≥</span>
                            <span id="mobileFees">$0 fees</span>
                        </div>
                    </div>
                </div>

                <!-- Inputs Card -->
                <div class="glass-card">
                    <!-- Mode Toggle -->
                    <div class="mode-toggle">
                        <button class="mode-btn active" id="forwardBtn">
                            üí∞ Calculate Profit
                        </button>
                        <button class="mode-btn" id="reverseBtn">
                            üéØ Find List Price
                        </button>
                    </div>

                    <div style="height:1px;background:rgba(255,255,255,0.08);margin-bottom:10px;"></div>

                    <div class="complexity-toggle">
                        <label>
                            <input type="checkbox" id="showAdvanced">
                            <span>‚öôÔ∏è Show Advanced Options</span>
                        </label>
                    </div>

                    <!-- Smart Category Search -->
                    <div class="category-search-wrapper">
                        <input 
                            type="text" 
                            class="category-search" 
                            id="categorySearch"
                            placeholder="Search category (e.g., 'iPhone', 'sneakers')..."
                            autocomplete="off"
                        >
                        <span class="search-icon">üîç</span>
                        <div class="category-suggestions" id="categorySuggestions"></div>
                    </div>

                    <!-- Essential Inputs -->
                    <div class="input-row" id="forwardInputRow">
                        <div class="input-group">
                            <label>Sale Price</label>
                            <input type="number" id="salePrice" placeholder="100.00" step="0.01" value="100">
                        </div>
                        <div class="input-group">
                            <label>Item Cost</label>
                            <input type="number" id="itemCost" placeholder="50.00" step="0.01" value="50">
                        </div>
                    </div>

                    <div class="input-row" id="reverseInputRow" style="display: none;">
                        <div class="input-group">
                            <label>Target Profit üéØ</label>
                            <input type="number" id="targetProfit" placeholder="30.00" step="0.01" value="30">
                        </div>
                        <div class="input-group">
                            <label>Item Cost</label>
                            <input type="number" id="itemCost2" placeholder="50.00" step="0.01" value="50">
                        </div>
                    </div>

                    <!-- Advanced Section -->
                    <div class="advanced-section" id="advancedSection">
                        <div class="input-row">
                            <div class="input-group">
                                <label>Buyer Paid Shipping</label>
                                <input type="number" id="buyerShipping" placeholder="0.00" step="0.01" value="0">
                            </div>
                            <div class="input-group">
                                <label>Your Shipping Cost</label>
                                <input type="number" id="shipping" placeholder="0.00" step="0.01" value="0">
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Packaging Cost</label>
                                <input type="number" id="packagingCost" placeholder="0.00" step="0.01" value="0">
                                <div class="input-helper">Box, tape, labels</div>
                            </div>
                            <div class="input-group">
                                <label>
                                    Store Level
                                    <span class="tooltip-trigger">
                                        ‚ìò
                                        <span class="tooltip-content">Store subscribers get lower fees!</span>
                                    </span>
                                </label>
                                <select id="storeLevel" class="category-select">
                                    <option value="none">No Store</option>
                                    <option value="basic">Basic Store</option>
                                    <option value="premium">Premium Store</option>
                                    <option value="anchor">Anchor Store</option>
                                    <option value="enterprise">Enterprise Store</option>
                                </select>
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>State Sales Tax</label>
                                <select id="stateTax">
                                    <option value="0">None ‚Äî No Sales Tax</option>
                                    <option value="4.00">Alabama (4.00%)</option>
                                    <option value="0">Alaska ‚Äî No Sales Tax</option>
                                    <option value="5.60">Arizona (5.60%)</option>
                                    <option value="6.50">Arkansas (6.50%)</option>
                                    <option value="7.25">California (7.25%)</option>
                                    <option value="2.90">Colorado (2.90%)</option>
                                    <option value="6.35">Connecticut (6.35%)</option>
                                    <option value="0">Delaware ‚Äî No Sales Tax</option>
                                    <option value="6.00">Florida (6.00%)</option>
                                    <option value="4.00">Georgia (4.00%)</option>
                                    <option value="4.00">Hawaii (4.00%)</option>
                                    <option value="6.00">Idaho (6.00%)</option>
                                    <option value="6.25">Illinois (6.25%)</option>
                                    <option value="7.00">Indiana (7.00%)</option>
                                    <option value="6.00">Iowa (6.00%)</option>
                                    <option value="6.50">Kansas (6.50%)</option>
                                    <option value="6.00">Kentucky (6.00%)</option>
                                    <option value="4.45">Louisiana (4.45%)</option>
                                    <option value="5.50">Maine (5.50%)</option>
                                    <option value="6.00">Maryland (6.00%)</option>
                                    <option value="6.25">Massachusetts (6.25%)</option>
                                    <option value="6.00">Michigan (6.00%)</option>
                                    <option value="6.875">Minnesota (6.875%)</option>
                                    <option value="7.00">Mississippi (7.00%)</option>
                                    <option value="4.225">Missouri (4.225%)</option>
                                    <option value="0">Montana ‚Äî No Sales Tax</option>
                                    <option value="5.50">Nebraska (5.50%)</option>
                                    <option value="6.85">Nevada (6.85%)</option>
                                    <option value="0">New Hampshire ‚Äî No Sales Tax</option>
                                    <option value="6.625">New Jersey (6.625%)</option>
                                    <option value="5.125">New Mexico (5.125%)</option>
                                    <option value="4.00">New York (4.00%)</option>
                                    <option value="4.75">North Carolina (4.75%)</option>
                                    <option value="5.00">North Dakota (5.00%)</option>
                                    <option value="5.75">Ohio (5.75%)</option>
                                    <option value="4.50">Oklahoma (4.50%)</option>
                                    <option value="0">Oregon ‚Äî No Sales Tax</option>
                                    <option value="6.00">Pennsylvania (6.00%)</option>
                                    <option value="7.00">Rhode Island (7.00%)</option>
                                    <option value="6.00">South Carolina (6.00%)</option>
                                    <option value="4.50">South Dakota (4.50%)</option>
                                    <option value="7.00">Tennessee (7.00%)</option>
                                    <option value="6.25">Texas (6.25%)</option>
                                    <option value="4.85">Utah (4.85%)</option>
                                    <option value="6.00">Vermont (6.00%)</option>
                                    <option value="5.30">Virginia (5.30%)</option>
                                    <option value="6.50">Washington (6.50%)</option>
                                    <option value="6.00">West Virginia (6.00%)</option>
                                    <option value="5.00">Wisconsin (5.00%)</option>
                                    <option value="4.00">Wyoming (4.00%)</option>
                                    <option value="5.75">Washington D.C. (5.75%)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>
                                    Tax on Fees
                                    <span class="tooltip-trigger">
                                        ‚ìò
                                        <span class="tooltip-content">Texas: ~2.44%</span>
                                    </span>
                                </label>
                                <input type="number" id="taxOnFees" placeholder="2.44" step="0.01" value="0">
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Promoted Listings</label>
                                <select id="adFee">
                                    <option value="0">None (0%)</option>
                                    <option value="2">2% - Minimum</option>
                                    <option value="5">5%</option>
                                    <option value="10">10% - Suggested</option>
                                    <option value="15">15%</option>
                                    <option value="20">20%</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Results -->
            <div class="right-panel">
                <div class="glass-card results-card">
                    <!-- Profit Health Indicator -->
                    <div class="profit-health">
                        <div class="health-dots">
                            <div class="health-dot" id="healthDot1"></div>
                            <div class="health-dot" id="healthDot2"></div>
                            <div class="health-dot" id="healthDot3"></div>
                        </div>
                        <div class="health-label" id="healthLabel">Calculating...</div>
                        <div class="health-score" id="healthScore">‚Äî</div>
                    </div>

                    <!-- Hero Result -->
                    <div class="result-hero">
                        <div class="result-label">Net Profit</div>
                        <div class="result-value" id="netProfit">$0.00</div>
                        <div class="result-margin" id="profitMarginDisplay">0% margin</div>
                    </div>

                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <!-- Always-Visible Summary Section                               -->
                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div class="result-summary" role="region" aria-label="Profit Summary">
                        <div class="result-row">
                            <span class="result-row-label">üí∞ Net Profit</span>
                            <span class="result-row-value" id="summaryProfit" style="font-weight: 700; color: var(--accent-purple-light);">$0.00</span>
                        </div>
                        <div class="result-row">
                            <span class="result-row-label">üìä Margin</span>
                            <span class="result-row-value" id="summaryMargin">0%</span>
                        </div>
                        <div class="result-row">
                            <span class="result-row-label">üí≥ Total Fees</span>
                            <span class="result-row-value" id="summaryFees">$0.00</span>
                        </div>
                    </div>

                    <div class="section-divider" role="separator"></div>

                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <!-- Revenue Breakdown (Collapsible)                              -->
                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div class="result-section" id="revenueSection" role="region" aria-labelledby="revenue-header">
                        <button class="result-section-header" 
                                data-section="revenue" 
                                aria-expanded="false" 
                                aria-controls="revenue-content"
                                type="button">
                            <div class="result-section-title" id="revenue-header">
                                <span class="result-section-icon" aria-hidden="true">üìà</span>
                                <span>Revenue Breakdown</span>
                            </div>
                            <span class="result-section-chevron" aria-hidden="true">‚ñº</span>
                            <span class="sr-only">Tap to expand</span>
                        </button>
                        <div class="result-section-content" id="revenue-content">
                            <div class="result-section-body">
                                <div class="result-row">
                                    <span class="result-row-label">Item Price</span>
                                    <span class="result-row-value" id="displaySalePrice">$0.00</span>
                                </div>
                                <div class="result-row">
                                    <span class="result-row-label">Total Sale Amount</span>
                                    <span class="result-row-value" id="totalSaleAmount">$0.00</span>
                                </div>
                                <div class="result-row">
                                    <span class="result-row-label">Sales Tax</span>
                                    <span class="result-row-value" id="salesTaxAmount">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <!-- Fee Breakdown (Collapsible, Default Expanded)                -->
                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div class="result-section expanded" id="feeSection" role="region" aria-labelledby="fee-header">
                        <button class="result-section-header" 
                                data-section="fee" 
                                aria-expanded="true" 
                                aria-controls="fee-content"
                                type="button">
                            <div class="result-section-title" id="fee-header">
                                <span class="result-section-icon" aria-hidden="true">üí≥</span>
                                <span>eBay Fee Breakdown</span>
                            </div>
                            <span class="result-section-chevron" aria-hidden="true">‚ñº</span>
                            <span class="sr-only">Tap to collapse</span>
                        </button>
                        <div class="result-section-content" id="fee-content">
                            <div class="result-section-body">
                                <div class="result-row">
                                    <span class="result-row-label">Final Value Fee</span>
                                    <span class="result-row-value" id="ebayFee">$0.00</span>
                                </div>
                                <div class="result-row">
                                    <span class="result-row-label">Per Order Fee</span>
                                    <span class="result-row-value" id="perOrderFee">$0.00</span>
                                </div>
                                <div class="result-row">
                                    <span class="result-row-label">Ad Fee</span>
                                    <span class="result-row-value" id="adFeeCost">$0.00</span>
                                </div>
                                <div class="result-row">
                                    <span class="result-row-label">Tax on Fees</span>
                                    <span class="result-row-value" id="taxOnFeesAmount">$0.00</span>
                                </div>
                                <div class="section-divider" role="separator"></div>
                                <div class="result-row">
                                    <span class="result-row-label" style="font-weight: 700;">Total eBay Fees</span>
                                    <span class="result-row-value" id="totalFees" style="font-weight: 700;">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <!-- Cost Breakdown (Collapsible)                                 -->
                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div class="result-section" id="costSection" role="region" aria-labelledby="cost-header">
                        <button class="result-section-header" 
                                data-section="cost" 
                                aria-expanded="false" 
                                aria-controls="cost-content"
                                type="button">
                            <div class="result-section-title" id="cost-header">
                                <span class="result-section-icon" aria-hidden="true">üì¶</span>
                                <span>Cost Breakdown</span>
                            </div>
                            <span class="result-section-chevron" aria-hidden="true">‚ñº</span>
                            <span class="sr-only">Tap to expand</span>
                        </button>
                        <div class="result-section-content" id="cost-content">
                            <div class="result-section-body">
                                <div class="result-row">
                                    <span class="result-row-label">Item Cost</span>
                                    <span class="result-row-value" id="displayItemCost">$0.00</span>
                                </div>
                                <div class="result-row">
                                    <span class="result-row-label">Shipping Cost</span>
                                    <span class="result-row-value" id="displayShipping">$0.00</span>
                                </div>
                                <div class="result-row">
                                    <span class="result-row-label">Packaging Cost</span>
                                    <span class="result-row-value" id="displayPackaging">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <button class="action-btn" id="saveBtn">üíæ Save</button>
                        <button class="action-btn" id="compareBtn">‚öñÔ∏è Compare</button>
                        <button class="action-btn" id="historyBtn">üìã History</button>
                        <button class="action-btn" id="resetBtn">üîÑ Reset</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         * APPLICATION STATE
         * Single source of truth for all app state (MVVM pattern)
         * Maps directly to SwiftUI @State and @Published properties
         * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê*/

        var AppState = {
            // Calculation Mode
            mode: 'forward',  // 'forward' | 'reverse'
            
            // Input Values
            selectedCategory: null,
            salePrice: 0,
            itemCost: 0,
            targetProfit: 0,
            shipping: 0,
            packaging: 0,
            storeTier: 'none',  // 'none' | 'basic' | 'premium' | 'anchor' | 'enterprise'
            stateTax: 0,
            adFeeEnabled: false,
            taxOnFeesEnabled: false,
            
            // UI State
            sectionStates: {
                revenue: false,
                fee: true,      // Expanded by default
                cost: false
            },
            advancedMode: false,
            
            // Computed Results (updated by calculate())
            results: {
                netProfit: 0,
                profitMargin: 0,
                totalFees: 0,
                fvfAmount: 0,
                perOrderFee: 0,
                adFee: 0,
                taxOnFees: 0,
                salesTax: 0,
                breakEven: 0,
                marginLevel: 'warning'  // 'excellent' | 'good' | 'fair' | 'warning' | 'negative'
            }
        };

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         * Swift Equivalent:
         * 
         * class CalculatorViewModel: ObservableObject {
         *     @Published var mode: CalculationMode = .forward
         *     @Published var selectedCategory: Category?
         *     @Published var salePrice: Double = 0
         *     @Published var itemCost: Double = 0
         *     // ... etc
         * }
         * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê*/

        // ========== CATEGORY DATA ==========
        const CATEGORIES = [
            { id: 'most',          name: 'Most Categories',           icon: 'üì¶', rate: 13.6,  popular: true },
            { id: 'cellphones',    name: 'Cell Phones & Smartphones', icon: 'üì±', rate: 13.6,  popular: true },
            { id: 'computers',     name: 'Computers & Tablets',       icon: 'üíª', rate: 13.6,  popular: true },
            { id: 'cameras',       name: 'Cameras & Photo',           icon: 'üì∑', rate: 13.6 },
            { id: 'media',         name: 'Books, Movies & Music',     icon: 'üìö', rate: 15.3,  popular: true },
            { id: 'jewelry',       name: 'Jewelry & Watches',         icon: 'üíé', rate: 15 },
            { id: 'athletic_shoes',name: 'Athletic Shoes',            icon: 'üëü', rate: 13.6,  popular: true },
            { id: 'guitars',       name: 'Guitars & Instruments',     icon: 'üé∏', rate: 6.7 },
            { id: 'trading_cards', name: 'Trading Cards',             icon: 'üé¥', rate: 13.25 },
            { id: 'clothing',      name: 'Clothing, Shoes & Accessories', icon: 'üëï', rate: 13.6, popular: true },
            { id: 'home',          name: 'Home & Garden',             icon: 'üè°', rate: 13.6 },
            { id: 'toys',          name: 'Toys & Hobbies',            icon: 'üß∏', rate: 13.6 },
            { id: 'sporting',      name: 'Sporting Goods',            icon: '‚öΩ', rate: 13.6 },
            { id: 'auto',          name: 'Auto Parts & Accessories',  icon: 'üîß', rate: 13.6 },
            { id: 'coins',         name: 'Coins & Paper Money',       icon: 'ü™ô', rate: 13.25 },
            { id: 'stamps',        name: 'Stamps',                    icon: '‚úâÔ∏è', rate: 13.6 },
            { id: 'health',        name: 'Health & Beauty',           icon: 'üíä', rate: 13.6 },
            { id: 'pet',           name: 'Pet Supplies',              icon: 'üêæ', rate: 13.6 },
        ];

        let selectedCategory = CATEGORIES[0];
        let currentMode = 'forward';
        let savedCalculations = JSON.parse(localStorage.getItem('modernCalcSaved') || '[]');

        // ========== THEME TOGGLE ==========
        const themeToggle = document.getElementById('themeToggle');
        const htmlElement = document.documentElement;

        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'light') {
            htmlElement.setAttribute('data-theme', 'light');
            themeToggle.classList.add('active');
        }

        themeToggle.addEventListener('click', () => {
            const newTheme = htmlElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            htmlElement.setAttribute('data-theme', newTheme);
            themeToggle.classList.toggle('active');
            localStorage.setItem('theme', newTheme);
        });

        // ========== MODE TOGGLE ==========
        document.getElementById('forwardBtn').addEventListener('click', () => setMode('forward'));
        document.getElementById('reverseBtn').addEventListener('click', () => setMode('reverse'));

        function setMode(mode) {
            currentMode = mode;
            const forwardBtn = document.getElementById('forwardBtn');
            const reverseBtn = document.getElementById('reverseBtn');
            forwardBtn.classList.toggle('active', mode === 'forward');
            reverseBtn.classList.toggle('active', mode === 'reverse');

            // Toggle input rows
            const forwardRow = document.getElementById('forwardInputRow');
            const reverseRow = document.getElementById('reverseInputRow');
            if (mode === 'reverse') {
                forwardRow.style.display = 'none';
                reverseRow.style.display = 'grid';
                // Sync itemCost between the two rows
                document.getElementById('itemCost2').value = document.getElementById('itemCost').value;
            } else {
                forwardRow.style.display = 'grid';
                reverseRow.style.display = 'none';
                // Sync back
                document.getElementById('itemCost').value = document.getElementById('itemCost2').value;
            }

            // Update result labels
            const resultLabel = document.querySelector('.result-hero .result-label');
            const mobileProfitLabel = document.querySelector('.mobile-profit-label');
            if (mode === 'reverse') {
                if (resultLabel) resultLabel.textContent = 'Required Sale Price';
                if (mobileProfitLabel) mobileProfitLabel.textContent = 'List At';
            } else {
                if (resultLabel) resultLabel.textContent = 'Net Profit';
                if (mobileProfitLabel) mobileProfitLabel.textContent = 'Net Profit';
            }
            calculate();
        }

        // ========== ADVANCED TOGGLE ==========
        document.getElementById('showAdvanced').addEventListener('change', (e) => {
            document.getElementById('advancedSection').classList.toggle('active', e.target.checked);
        });

        // ========== CATEGORY SEARCH ==========
        const categorySearch = document.getElementById('categorySearch');
        const categorySuggestions = document.getElementById('categorySuggestions');

        categorySearch.addEventListener('focus', () => {
            renderCategorySuggestions('');
            categorySuggestions.classList.add('active');
        });

        categorySearch.addEventListener('input', (e) => {
            renderCategorySuggestions(e.target.value);
            categorySuggestions.classList.add('active');
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.category-search-wrapper')) {
                categorySuggestions.classList.remove('active');
            }
        });

        function renderCategorySuggestions(query) {
            const q = (query || '').toLowerCase();
            const filtered = CATEGORIES.filter(cat => cat.name.toLowerCase().includes(q));
            const popular = filtered.filter(c => c.popular);
            const all = filtered.filter(c => !c.popular);

            let html = '';
            if (!q && popular.length) {
                html += '<div class="suggestion-group-label">‚≠ê Popular</div>';
                popular.forEach(cat => { html += renderSuggestion(cat); });
                if (all.length) {
                    html += '<div class="suggestion-group-label">All Categories</div>';
                    all.forEach(cat => { html += renderSuggestion(cat); });
                }
            } else {
                if (filtered.length) {
                    html += '<div class="suggestion-group-label">Search Results</div>';
                    filtered.forEach(cat => { html += renderSuggestion(cat); });
                } else {
                    html += '<div style="padding:16px;color:var(--text-muted);font-size:0.875rem;text-align:center;">No categories found</div>';
                }
            }
            categorySuggestions.innerHTML = html;
        }

        function renderSuggestion(cat) {
            var rateDisplay = cat.tiers[0].rate + '%';
            if (cat.tiers.length > 1) {
                rateDisplay += ' (tiered)';
            }
            return `<div class="category-suggestion" onclick="selectCategory('${cat.id}')">
                <span class="category-suggestion-icon">${cat.icon}</span>
                <div class="category-suggestion-text">
                    <div class="category-suggestion-name">${cat.name}</div>
                    <div class="category-suggestion-rate">${rateDisplay} FVF</div>
                </div>
            </div>`;
        }

        function selectCategory(id) {
            const cat = CATEGORIES.find(c => c.id === id);
            if (!cat) return;
            selectedCategory = cat;
            categorySearch.value = cat.icon + ' ' + cat.name;
            categorySuggestions.classList.remove('active');
            calculate();
        }

        // ========== CALCULATE ==========
        function calculate() {
            if (currentMode === 'reverse') {
                calculateReverse();
            } else {
                calculateForward();
            }
        }

        function calculateForward() {
            const salePrice     = parseFloat(document.getElementById('salePrice').value)     || 0;
            const itemCost      = parseFloat(document.getElementById('itemCost').value)      || 0;
            const buyerShipping = parseFloat(document.getElementById('buyerShipping').value) || 0;
            const shipping      = parseFloat(document.getElementById('shipping').value)      || 0;
            const packagingCost = parseFloat(document.getElementById('packagingCost').value) || 0;
            const stateTaxRate  = parseFloat(document.getElementById('stateTax').value)      / 100 || 0;
            const adFeeRate     = parseFloat(document.getElementById('adFee').value)         / 100 || 0;
            const taxOnFeesRate = parseFloat(document.getElementById('taxOnFees').value)     / 100 || 0;

            const totalSaleAmount  = salePrice + buyerShipping;
            const salesTaxAmount   = totalSaleAmount * stateTaxRate;
            const totalBuyerPays   = totalSaleAmount + salesTaxAmount;
            const fvfRate          = selectedCategory.rate / 100;
            const ebayFee          = totalBuyerPays * fvfRate;
            const perOrderFee      = totalSaleAmount <= 10 ? 0.30 : 0.40;
            const adFeeCost        = totalBuyerPays * adFeeRate;
            const taxOnFeesAmount  = (ebayFee + perOrderFee) * taxOnFeesRate;
            const totalFees        = ebayFee + perOrderFee + adFeeCost + taxOnFeesAmount;
            const netProfit        = totalSaleAmount - totalFees - itemCost - shipping - packagingCost;
            const profitMargin     = totalSaleAmount > 0 ? (netProfit / totalSaleAmount) * 100 : 0;

            updateUI(salePrice, totalSaleAmount, salesTaxAmount, ebayFee, perOrderFee, adFeeCost,
                     taxOnFeesAmount, totalFees, itemCost, shipping, packagingCost, netProfit, profitMargin);
        }

        function calculateReverse() {
            // Get inputs
            const targetProfit  = parseFloat(document.getElementById('targetProfit').value)  || 0;
            const itemCost      = parseFloat(document.getElementById('itemCost2').value)     || 0;
            const buyerShipping = parseFloat(document.getElementById('buyerShipping').value) || 0;
            const shipping      = parseFloat(document.getElementById('shipping').value)      || 0;
            const packagingCost = parseFloat(document.getElementById('packagingCost').value) || 0;
            const stateTaxRate  = parseFloat(document.getElementById('stateTax').value)      / 100 || 0;
            const adFeeRate     = parseFloat(document.getElementById('adFee').value)         / 100 || 0;
            const taxOnFeesRate = parseFloat(document.getElementById('taxOnFees').value)     / 100 || 0;
            const fvfRate       = selectedCategory.rate / 100;

            // Iterative solver: find salePrice such that netProfit = targetProfit
            // Start with initial guess
            var salePrice = targetProfit + itemCost + shipping + packagingCost + 10;

            // Newton-Raphson iteration (converges in ~3-5 steps)
            for (var i = 0; i < 20; i++) {
                var totalSaleAmount = salePrice + buyerShipping;
                var salesTaxAmount  = totalSaleAmount * stateTaxRate;
                var totalBuyerPays  = totalSaleAmount + salesTaxAmount;
                var ebayFee         = totalBuyerPays * fvfRate;
                var perOrderFee     = totalSaleAmount <= 10 ? 0.30 : 0.40;
                var adFeeCost       = totalBuyerPays * adFeeRate;
                var taxOnFeesAmount = (ebayFee + perOrderFee) * taxOnFeesRate;
                var totalFees       = ebayFee + perOrderFee + adFeeCost + taxOnFeesAmount;
                var netProfit       = totalSaleAmount - totalFees - itemCost - shipping - packagingCost;

                var error = targetProfit - netProfit;

                // Converged within 1 cent
                if (Math.abs(error) < 0.01) break;

                // Adjust sale price
                var effectiveRate = fvfRate + adFeeRate + (stateTaxRate * (fvfRate + adFeeRate)) + taxOnFeesRate * (fvfRate);
                salePrice += error / (1 - effectiveRate);
            }

            // Final calculation with converged price
            var totalSaleAmount = salePrice + buyerShipping;
            var salesTaxAmount  = totalSaleAmount * stateTaxRate;
            var totalBuyerPays  = totalSaleAmount + salesTaxAmount;
            var ebayFee         = totalBuyerPays * fvfRate;
            var perOrderFee     = totalSaleAmount <= 10 ? 0.30 : 0.40;
            var adFeeCost       = totalBuyerPays * adFeeRate;
            var taxOnFeesAmount = (ebayFee + perOrderFee) * taxOnFeesRate;
            var totalFees       = ebayFee + perOrderFee + adFeeCost + taxOnFeesAmount;
            var netProfit       = totalSaleAmount - totalFees - itemCost - shipping - packagingCost;
            var profitMargin    = totalSaleAmount > 0 ? (netProfit / totalSaleAmount) * 100 : 0;

            updateUI(salePrice, totalSaleAmount, salesTaxAmount, ebayFee, perOrderFee, adFeeCost,
                     taxOnFeesAmount, totalFees, itemCost, shipping, packagingCost, netProfit, profitMargin);
        }

        function updateUI(salePrice, totalSaleAmount, salesTaxAmount, ebayFee, perOrderFee, adFeeCost,
                          taxOnFeesAmount, totalFees, itemCost, shipping, packagingCost, netProfit, profitMargin) {
            // Update result breakdowns
            document.getElementById('displaySalePrice').textContent   = '$' + salePrice.toFixed(2);
            document.getElementById('totalSaleAmount').textContent     = '$' + totalSaleAmount.toFixed(2);
            document.getElementById('salesTaxAmount').textContent      = '$' + salesTaxAmount.toFixed(2);
            document.getElementById('ebayFee').textContent             = '$' + ebayFee.toFixed(2);
            document.getElementById('perOrderFee').textContent         = '$' + perOrderFee.toFixed(2);
            document.getElementById('adFeeCost').textContent           = '$' + adFeeCost.toFixed(2);
            document.getElementById('taxOnFeesAmount').textContent     = '$' + taxOnFeesAmount.toFixed(2);
            document.getElementById('totalFees').textContent           = '$' + totalFees.toFixed(2);
            document.getElementById('displayItemCost').textContent     = '$' + itemCost.toFixed(2);
            document.getElementById('displayShipping').textContent     = '$' + shipping.toFixed(2);
            document.getElementById('displayPackaging').textContent    = '$' + packagingCost.toFixed(2);

            // Hero display: show sale price in reverse mode, net profit in forward mode
            var profitEl = document.getElementById('netProfit');
            var heroValue = currentMode === 'reverse' ? salePrice : netProfit;
            profitEl.textContent = '$' + heroValue.toFixed(2);
            profitEl.style.color = (currentMode === 'reverse' || netProfit >= 0) ? '#ffffff' : '#fca5a5';
            profitEl.classList.add('success-animation');
            setTimeout(function() { profitEl.classList.remove('success-animation'); }, 600);

            document.getElementById('profitMarginDisplay').textContent = profitMargin.toFixed(1) + '% margin';

            // Mobile bar
            var mobileValue = currentMode === 'reverse' ? salePrice : netProfit;
            document.getElementById('mobileProfitValue').textContent = '$' + mobileValue.toFixed(2);
            document.getElementById('mobileProfitValue').style.color = (currentMode === 'reverse' || netProfit >= 0) ? 'white' : '#fca5a5';
            document.getElementById('mobileMargin').textContent = profitMargin.toFixed(1) + '% margin';
            document.getElementById('mobileFees').textContent   = '$' + totalFees.toFixed(2) + ' fees';

            updateHealthIndicator(profitMargin);

            // Update always-visible summary section
            document.getElementById('summaryProfit').textContent = '$' + (currentMode === 'reverse' ? salePrice : netProfit).toFixed(2);
            document.getElementById('summaryMargin').textContent = profitMargin.toFixed(1) + '%';
            document.getElementById('summaryFees').textContent = '$' + totalFees.toFixed(2);
        }


        function updateHealthIndicator(margin) {
            const dots  = [1,2,3].map(n => document.getElementById('healthDot' + n));
            const label = document.getElementById('healthLabel');
            const score = document.getElementById('healthScore');
            dots.forEach(d => { d.className = 'health-dot'; });

            if (margin >= 30) {
                dots.forEach(d => d.classList.add('active'));
                label.textContent = 'Excellent Profit!';
                score.textContent = '10';
            } else if (margin >= 20) {
                dots[0].classList.add('active'); dots[1].classList.add('active');
                label.textContent = 'Good Margin';
                score.textContent = (7 + (margin - 20) / 10).toFixed(1);
            } else if (margin >= 10) {
                dots[0].classList.add('active', 'warning');
                label.textContent = 'Fair Margin';
                score.textContent = (5 + (margin - 10) / 10).toFixed(1);
            } else if (margin >= 0) {
                dots[0].classList.add('active', 'danger');
                label.textContent = 'Low Margin';
                score.textContent = (margin / 10 * 5).toFixed(1);
            } else {
                label.textContent = 'Losing Money';
                score.textContent = '0';
            }
        }

        // ========== ACTION BUTTONS ==========
        document.getElementById('saveBtn').addEventListener('click', saveCalculation);
        document.getElementById('historyBtn').addEventListener('click', toggleHistory);
        document.getElementById('resetBtn').addEventListener('click', resetAll);
        document.getElementById('compareBtn').addEventListener('click', () => {
            if (savedCalculations.length < 2) {
                showToast('üí° Save at least 2 calculations to compare!', 'info');
            } else {
                showToast('‚öñÔ∏è Compare mode coming soon!', 'info');
            }
        });

        function saveCalculation() {
            var hp = document.getElementById('historyPanel');
            if (hp) hp.remove();
            var existing = document.getElementById('savePanel');
            if (existing) { existing.remove(); return; }

            var panel = document.createElement('div');
            panel.id = 'savePanel';
            panel.className = 'save-panel';

            var profit = document.getElementById('netProfit').textContent;
            var defaultName = selectedCategory.name.split(' ')[0] + ' ‚Äî ' + profit;

            var lbl = document.createElement('span');
            lbl.className = 'save-panel-label';
            lbl.textContent = 'Name this calculation';

            var inp = document.createElement('input');
            inp.id = 'saveNameInput';
            inp.className = 'save-panel-input';
            inp.type = 'text';
            inp.placeholder = 'e.g. iPhone 15 Pro';
            inp.value = defaultName;
            inp.autocomplete = 'off';

            var btnRow = document.createElement('div');
            btnRow.className = 'save-panel-btns';

            var okBtn = document.createElement('button');
            okBtn.className = 'save-confirm-btn';
            okBtn.type = 'button';
            okBtn.textContent = 'Save';
            okBtn.addEventListener('click', confirmSave);

            var cancelBtn = document.createElement('button');
            cancelBtn.className = 'save-cancel-btn';
            cancelBtn.type = 'button';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.addEventListener('click', function() {
                var p = document.getElementById('savePanel');
                if (p) p.remove();
            });

            btnRow.appendChild(okBtn);
            btnRow.appendChild(cancelBtn);
            panel.appendChild(lbl);
            panel.appendChild(inp);
            panel.appendChild(btnRow);

            var qa = document.getElementById('saveBtn').closest('.quick-actions');
            qa.parentNode.insertBefore(panel, qa.nextSibling);

            inp.focus();
            inp.select();
            inp.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') confirmSave();
                if (e.key === 'Escape') { var p = document.getElementById('savePanel'); if (p) p.remove(); }
            });
        }

        function confirmSave() {
            var inp = document.getElementById('saveNameInput');
            if (!inp) return;
            var name = inp.value.trim();
            if (!name) { inp.focus(); return; }
            var profit = document.getElementById('netProfit').textContent;
            var margin = document.getElementById('profitMarginDisplay').textContent;
            savedCalculations.unshift({
                name: name,
                timestamp: new Date().toISOString(),
                profit: profit,
                margin: margin,
                data: {
                    salePrice:     document.getElementById('salePrice').value,
                    itemCost:      document.getElementById('itemCost').value,
                    buyerShipping: document.getElementById('buyerShipping').value,
                    shipping:      document.getElementById('shipping').value,
                    packagingCost: document.getElementById('packagingCost').value,
                    stateTax:      document.getElementById('stateTax').value,
                    adFee:         document.getElementById('adFee').value,
                    taxOnFees:     document.getElementById('taxOnFees').value,
                    categoryId:    selectedCategory.id,
                    mode:          currentMode
                }
            });
            if (savedCalculations.length > 20) savedCalculations.pop();
            try { localStorage.setItem('modernCalcSaved', JSON.stringify(savedCalculations)); } catch(e) {}
            var p = document.getElementById('savePanel'); if (p) p.remove();
            showToast('‚úÖ Saved: ' + name, 'success');
        }

        function toggleHistory() {
            let panel = document.getElementById('historyPanel');
            if (panel) {
                panel.remove();
                return;
            }
            panel = document.createElement('div');
            panel.id = 'historyPanel';
            panel.style.cssText = `
                margin-top: var(--space-3);
                padding: var(--space-3);
                background: var(--glass-bg);
                border: 1px solid var(--glass-border);
                border-radius: var(--radius-lg);
                max-height: 280px;
                overflow-y: auto;
            `;
            if (!savedCalculations.length) {
                panel.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:0.875rem;">No saved calculations yet.<br>Hit üíæ Save to start!</div>';
            } else {
                panel.innerHTML = savedCalculations.map((c, i) => `
                    <div style="display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.07);transition:background 0.2s;" 
                         onmouseover="this.style.background='rgba(102,126,234,0.15)'" 
                         onmouseout="this.style.background='transparent'"
                         onclick="loadCalc(${i})">
                        <div style="flex:1;">
                            <div style="font-size:0.875rem;font-weight:700;color:var(--text-primary);">${c.name}</div>
                            <div style="font-size:0.75rem;color:var(--text-muted);margin-top:2px;">
                                ${new Date(c.timestamp).toLocaleDateString()} ¬∑ ${c.profit} ¬∑ ${c.margin}
                            </div>
                        </div>
                        <button onclick="event.stopPropagation();deleteCalc(${i})" 
                                style="background:none;border:none;color:#ef4444;font-size:1rem;cursor:pointer;padding:4px 8px;border-radius:6px;">‚úï</button>
                    </div>`).join('');
            }
            document.getElementById('resetBtn').parentElement.after(panel);
        }

        function loadCalc(index) {
            const c = savedCalculations[index];
            if (!c) return;
            document.getElementById('salePrice').value     = c.data.salePrice || '';
            document.getElementById('itemCost').value      = c.data.itemCost || '';
            document.getElementById('buyerShipping').value = c.data.buyerShipping || 0;
            document.getElementById('shipping').value      = c.data.shipping || 0;
            document.getElementById('packagingCost').value = c.data.packagingCost || 0;
            document.getElementById('stateTax').value      = c.data.stateTax || 0;
            document.getElementById('adFee').value         = c.data.adFee || 0;
            document.getElementById('taxOnFees').value     = c.data.taxOnFees || 0;
            const cat = CATEGORIES.find(x => x.id === c.data.categoryId) || CATEGORIES[0];
            selectCategory(cat.id);
            if (c.data.mode) setMode(c.data.mode);
            else calculate();
            document.getElementById('historyPanel')?.remove();
            showToast('üìÇ Loaded: ' + c.name, 'success');
        }

        function deleteCalc(index) {
            savedCalculations.splice(index, 1);
            localStorage.setItem('modernCalcSaved', JSON.stringify(savedCalculations));
            toggleHistory(); toggleHistory(); // re-render
        }

        function resetAll() {
            document.getElementById('salePrice').value     = 100;
            document.getElementById('itemCost').value      = 50;
            document.getElementById('buyerShipping').value = 0;
            document.getElementById('shipping').value      = 0;
            document.getElementById('packagingCost').value = 0;
            document.getElementById('stateTax').value      = 0;
            document.getElementById('adFee').value         = 0;
            document.getElementById('taxOnFees').value     = 0;
            selectCategory('most');
            setMode('forward');
            document.getElementById('historyPanel')?.remove();
            showToast('üîÑ Reset complete!', 'info');
        }

        // ========== TOAST NOTIFICATIONS ==========
        function showToast(message, type = 'info') {
            const existing = document.getElementById('toast');
            if (existing) existing.remove();

            const colors = { success: '#10b981', info: '#667eea', warning: '#f59e0b', error: '#ef4444' };
            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%) translateY(20px);
                background: ${colors[type] || colors.info};
                color: white;
                padding: 12px 24px;
                border-radius: 9999px;
                font-size: 0.875rem;
                font-weight: 600;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                z-index: 9999;
                opacity: 0;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                pointer-events: none;
                white-space: nowrap;
            `;
            document.body.appendChild(toast);
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(-50%) translateY(0)';
            });
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // ========== INPUT LISTENERS ==========
        ['salePrice','itemCost','targetProfit','itemCost2','buyerShipping','shipping','packagingCost','taxOnFees'].forEach(id => {
            var el = document.getElementById(id);
            if (el) el.addEventListener('input', calculate);
        });
        ['stateTax','adFee','storeLevel'].forEach(id => {
            var el = document.getElementById(id);
            if (el) el.addEventListener('change', calculate);
        });

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         * Collapsible Sections - iOS-Compliant Implementation
         * Follows Apple's HIG for touch interactions and accessibility
         * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê*/

        

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         * CALCULATION ENGINE (Pure Functions)
         * These functions have NO side effects - they only calculate and return
         * Drop these directly into Swift's CalculationEngine.swift
         * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê*/

        /**
         * Calculate all results from inputs (Forward mode)
         * @param {Object} inputs - Calculation inputs
         * @returns {Object} Complete results object
         * 
         * Swift equivalent:
         * func calculateResults(inputs: CalculationInputs) -> CalculationResults
         */
        function calculateResults(inputs) {
            // Extract inputs
            var salePrice = inputs.salePrice || 0;
            var itemCost = inputs.itemCost || 0;
            var shipping = inputs.shipping || 0;
            var packaging = inputs.packaging || 0;
            var category = inputs.selectedCategory;
            
            // Calculate fees
            var fvf = calculateTieredFVF(salePrice, category);
            var perOrderFee = salePrice >= 10 ? 0.30 : 0.40;
            var adFee = inputs.adFeeEnabled ? salePrice * 0.01 : 0;
            var totalFees = fvf + perOrderFee + adFee;
            
            // Calculate costs
            var totalCosts = itemCost + shipping + packaging;
            
            // Calculate profit
            var netProfit = salePrice - totalCosts - totalFees;
            var profitMargin = salePrice > 0 ? (netProfit / salePrice) * 100 : 0;
            
            // Calculate break-even
            var breakEven = totalCosts / (1 - 0.15);
            
            // Determine margin level
            var marginLevel = getMarginLevel(profitMargin);
            
            return {
                netProfit: netProfit,
                profitMargin: profitMargin,
                totalFees: totalFees,
                fvfAmount: fvf,
                perOrderFee: perOrderFee,
                adFee: adFee,
                breakEven: breakEven,
                marginLevel: marginLevel
            };
        }

        /**
         * Determine margin quality level
         * @param {number} margin - Profit margin percentage
         * @returns {string} Margin level classification
         * 
         * Swift equivalent:
         * func getMarginLevel(_ margin: Double) -> MarginLevel
         */
        function getMarginLevel(margin) {
            if (margin >= 25) return 'excellent';
            if (margin >= 15) return 'good';
            if (margin >= 10) return 'fair';
            if (margin >= 0) return 'warning';
            return 'negative';
        }

        /**
         * Calculate required sale price from target profit (Reverse mode)
         * Uses Newton-Raphson iterative solver
         * @param {Object} inputs - Reverse calculation inputs
         * @returns {number} Required sale price
         * 
         * Swift equivalent:
         * func calculateReversePrice(inputs: ReverseInputs) -> Double
         */
        function calculateReversePrice(inputs) {
            var targetProfit = inputs.targetProfit || 0;
            var itemCost = inputs.itemCost || 0;
            var shipping = inputs.shipping || 0;
            var packaging = inputs.packaging || 0;
            var totalCosts = itemCost + shipping + packaging;
            
            // Initial guess
            var salePrice = targetProfit + totalCosts + 10;
            var maxIterations = 20;
            
            // Newton-Raphson iteration
            for (var i = 0; i < maxIterations; i++) {
                var fees = calculateTieredFVF(salePrice, inputs.selectedCategory);
                fees += salePrice >= 10 ? 0.30 : 0.40;  // Per-order fee
                
                var actualProfit = salePrice - totalCosts - fees;
                var error = targetProfit - actualProfit;
                
                // Converged?
                if (Math.abs(error) < 0.01) break;
                
                // Adjust price
                salePrice += error / (1 - 0.15);
            }
            
            return salePrice;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         * These functions are now "Swift-ready":
         * - No DOM manipulation
         * - No side effects
         * - Pure input ‚Üí output
         * - Can be unit tested
         * - Drop into CalculationEngine.swift almost unchanged
         * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê*/

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         * UI COMPONENT FUNCTIONS
         * Each function creates a UI element (maps to SwiftUI View)
         * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê*/

        /**
         * Update all UI elements with new results
         * In Swift: This becomes computed properties on ViewModel
         * @param {Object} results - Calculation results
         */
        function updateUIWithResults(results) {
            // Hero card
            var profitDisplay = document.getElementById('netProfit');
            if (profitDisplay) {
                profitDisplay.textContent = formatCurrency(results.netProfit);
            }
            
            var marginDisplay = document.getElementById('profitMarginDisplay');
            if (marginDisplay) {
                marginDisplay.textContent = results.profitMargin.toFixed(1) + '%';
            }
            
            // Summary section
            var summaryProfit = document.getElementById('summaryProfit');
            if (summaryProfit) {
                summaryProfit.textContent = formatCurrency(results.netProfit);
            }
            
            var summaryMargin = document.getElementById('summaryMargin');
            if (summaryMargin) {
                summaryMargin.textContent = results.profitMargin.toFixed(1) + '%';
            }
            
            var summaryFees = document.getElementById('summaryFees');
            if (summaryFees) {
                summaryFees.textContent = formatCurrency(results.totalFees);
            }
            
            var breakEvenPrice = document.getElementById('breakEvenPrice');
            if (breakEvenPrice) {
                breakEvenPrice.textContent = formatCurrency(results.breakEven);
            }
            
            // Apply margin colors (iOS system colors)
            updateMarginColors(results.profitMargin);
        }

        /**
         * Format number as currency
         * In Swift: Text(value, format: .currency(code: "USD"))
         * @param {number} value - Number to format
         * @returns {string} Formatted currency string
         */
        function formatCurrency(value) {
            return '$' + value.toFixed(2);
        }

        /**
         * Format number as percentage
         * In Swift: Text("\(value, specifier: "%.1f")%")
         * @param {number} value - Number to format
         * @returns {string} Formatted percentage string
         */
        function formatPercentage(value) {
            return value.toFixed(1) + '%';
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         * Swift View Examples:
         * 
         * struct ResultRow: View {
         *     let label: String
         *     let value: String
         *     
         *     var body: some View {
         *         HStack {
         *             Text(label).foregroundColor(.secondary)
         *             Spacer()
         *             Text(value).fontWeight(.semibold)
         *         }
         *     }
         * }
         * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê*/

// Moved to AppState.sectionStates

        // Initialize from localStorage
        function initCollapsibleSections() {
            console.log('Initializing collapsible sections...');
            try {
                var saved = localStorage.getItem('ebayCalcSections');
                sectionStates = saved ? JSON.parse(saved) : { fees: true };
                console.log('Loaded section states:', sectionStates);
            } catch(e) {
                console.warn('localStorage unavailable, using defaults');
                sectionStates = { fee: true }; // Fees expanded by default
            }

            // Apply saved states
            var sections = ['revenue', 'fee', 'cost'];
            sections.forEach(function(name) {
                var section = document.getElementById(name + 'Section');
                if (!section) return;

                var isExpanded = sectionStates[name] || false;
                if (isExpanded) {
                    section.classList.add('expanded');
                    var btn = section.querySelector('.result-section-header');
                    if (btn) btn.setAttribute('aria-expanded', 'true');
                }
            });

            attachSectionListeners();
        }

        // Attach event listeners with iOS touch handling
        function attachSectionListeners() {
            var headers = document.querySelectorAll('.result-section-header');
            console.log('Found', headers.length, 'section headers');
            
            headers.forEach(function(header, index) {
                console.log('Attaching listeners to header', index, 'with data-section:', header.getAttribute('data-section'));
                
                // Click handler (keyboard + mouse)
                header.addEventListener('click', function(e) {
                    var section = this.getAttribute('data-section');
                    console.log('Header clicked, section:', section);
                    if (section) {
                        toggleSection(section);
                    } else {
                        console.error('No data-section attribute found on:', this);
                    }
                });

                // iOS touch feedback - add 'touching' class
                header.addEventListener('touchstart', function() {
                    this.classList.add('touching');
                }, { passive: true });

                header.addEventListener('touchend', function() {
                    var self = this;
                    setTimeout(function() {
                        self.classList.remove('touching');
                    }, 150);
                }, { passive: true });

                header.addEventListener('touchcancel', function() {
                    this.classList.remove('touching');
                }, { passive: true });
            });
        }

        // Toggle section with animation
        function toggleSection(name) {
            var section = document.getElementById(name + 'Section');
            if (!section) {
                console.error('Section not found:', name + 'Section');
                return;
            }
            console.log('Toggling section:', name);

            var isExpanded = section.classList.contains('expanded');
            var header = section.querySelector('.result-section-header');
            var srText = header.querySelector('.sr-only');

            if (isExpanded) {
                // Collapse
                section.classList.remove('expanded');
                if (header) header.setAttribute('aria-expanded', 'false');
                if (srText) srText.textContent = 'Tap to expand';
                sectionStates[name] = false;
            } else {
                // Expand
                section.classList.add('expanded');
                if (header) header.setAttribute('aria-expanded', 'true');
                if (srText) srText.textContent = 'Tap to collapse';
                sectionStates[name] = true;
            }

            // Persist to localStorage
            try {
                localStorage.setItem('ebayCalcSections', JSON.stringify(sectionStates));
            } catch(e) {
                // Continue without persistence if localStorage unavailable
            }

            // iOS haptic feedback (if supported)
            if (window.navigator && window.navigator.vibrate) {
                window.navigator.vibrate(10);
            }
        }

        // ========== INIT ==========
        selectCategory('most');
        calculate();

        // Initialize collapsible sections
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCollapsibleSections);
        } else {
            initCollapsibleSections();
        }
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Create inline service worker
                var swCode = `
                    const CACHE_NAME = 'ebay-calc-v2.3.1';
                    const urlsToCache = ['./', 'index.html'];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    });
                    
                    self.addEventListener('activate', event => {
                        event.waitUntil(
                            caches.keys().then(keys => 
                                Promise.all(
                                    keys.filter(key => key !== CACHE_NAME)
                                        .map(key => caches.delete(key))
                                )
                            )
                        );
                    });
                `;
                
                var blob = new Blob([swCode], { type: 'application/javascript' });
                var swURL = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swURL)
                    .then(function(registration) {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
